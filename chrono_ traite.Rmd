---
title: 'The Trans-Atlantic Slave Trade Database, éléments de périodisation de la traite
  occidentale atlantique '
author: "w cariou ufr HHAU Université de Nantes"
date: "Wednesday, June 03, 2015. 10/03/16"
output:
  word_document:
    toc: yes
  html_document:
    number_sections: yes
    toc: yes
---


********************************************************************************

Les séries chronologiques chroniques ou encore séries temporelles sont des distributions statistiques qui décrivent de manière chiffrée des phénomènes repérés dans le temps. (Py, 2013).

# Préalables

## Importation des données

```{r eval = FALSE}

voyages<-read.table("tastdb_105var.csv",
                    header=TRUE, sep=",",
                    na.strings="",
                    quote = "\"",
                    dec=".") 
```

## Appel des packages

```{r eval = FALSE}

# A Grammar of Data Manipulation
library (dplyr) # 0.4.3 

# An Implementation of the Grammar of Graphics
library (ggplot2) # 2.1.0


```

## Les données temporelles au sein de la TSTDb

variable yearam
http://www.slavevoyages.org/voyage/understanding-db/methodology-7


## Réagencement du tableau de données *voyages* en fonction de la colonne yearam

```{r eval = FALSE}

chrono_voyages <- voyages %>%
                  select(1,yearam, 2:105) %>%
                  arrange(yearam)  
    
```

# Exploration de la chronologie de la traite à l'aide de tables et de résumés statistiques
##  Bornes chronologiques et durée de la traite

```{r  eval = FALSE}

# Première mention d'une expédition de traite
ymin = min(voyages$yearam) 
ymin  # Affichage

# Ultime mention d'une expédition de traite
ymax = max (voyages$yearam)
ymax  # Affichage

# Etendue
duration <-  ymax-ymin
duration  # Affichage

```


## Distribution chronologique des expéditions de traite atlantique selon les années

* Tableau statistique

```{r  eval = FALSE}


n_voyages <- voyages %>%
                  count (yearam)

```


## Les interruptions de la traite

### Chronologie de la traite complétée par les années d'interruption du trafic

```{r}
range <- data.frame (yearam = c(1514:1866)) 
range


complete_n_voyages <- left_join(range, n_voyages)
complete_n_voyages


```
Références: https://stat545-ubc.github.io/bit001_dplyr-cheatsheet.html#left_joinsuperheroes-publishers

LEFT JOIN (ou LEFT OUTER JOIN) : jointure externe pour retourner tous les enregistrements de la table de gauche (LEFT = gauche) même si la condition n’est pas vérifié dans l’autre table.


### Identification des années d'interruption de la traite                

```{r  eval = FALSE}

no_voyages <- complete_n_voyages  %>%
                        filter (! complete.cases(n)) 

```

### Effectif total des années comportant ou non des expéditions de traite

```{r  eval = FALSE}

nrow (n_voyages) 
nrow (no_voyages)

```


##  Nombre moyen des expéditions de traite par année {base}

```{r  eval = FALSE}

total <- sum(n_voyages$n)

total/duration

```


## Distribution des effectifs des esclaves embarqués en fonction des années

```{r  eval = FALSE}

# 1ere version
chrono_slaves1
<- voyages %>%
                   group_by (yearam) %>%
                   summarise (esclaves = sum(slaximp))

# Les résultats posent problème...

# 2nde version
chrono_slaves <- voyages %>%
                   filter(complete.cases(slaximp)) %>%
                   group_by (yearam) %>%
                   summarise (esclaves = sum(slaximp))

```










# Représentations graphiques

## Représentations graphiques élementaires {base}

```{r  eval = FALSE}

# Représention graphique élementaire 

# source: n_voyages (diagramme en bâton ou tuyaux d'orgue)
# source: complete_n_voyages (diagramme en courbe ou en marches d'escalier)

basic_chart_chrono1 <- plot(n_voyages) 

# Argument type = "histogram like" 

basic_chart_chrono1 <- plot(n_voyages, t="h",
                    main = "Titre",
                    sub ="Sous-titre",
                    xlab = "étiquette axe des x",
                    ylab = "étiquette axe des y") 

# Argument type = "line"
basic_chart_chrono2 <- plot(complete_n_voyages, t="l",
                    main = "Titre",
                    sub ="Sous-titre",
                    xlab = "étiquette axe des x",
                    ylab = "étiquette axe des y")
                    

# Argument type = "stairs"
basic_chart_chrono3 <- plot(complete_n_voyages, t="s",
                    main = "Distribution chronologique des expéditions de traite atlantique",
                    sub ="The Trans-Atlantic Slave Trade Database (variable yearam)",
                    xlab = "",
                    ylab = "expéditions")                    

```


## ## Représentations graphiques avancées {ggplot2}

```{r}

library (ggplot2)

````

### Représentation graphique en courbe

```{r  eval = FALSE}

ggplot_line_chrono <- ggplot (complete_n_voyages, aes(x=yearam, y=n))  
ggplot_line_chrono +
       geom_line () +
       scale_x_continuous(breaks=seq(1500, 1875, by=25)) +
      # habillage
      ylab("expéditions") +                       
      xlab("années") +
      theme_bw() +
      ggtitle ("Distribution chronologique des expéditions de traite atlantique") +
            annotate("text", x = 1880, y = 120, label="The Trans-Atlantic Slave Trade Database (2010) variable yearam", size = 4, angle = 90)             
  
```

### Représentation graphique en marches d'escalier

```{r  eval = FALSE}

ggplot_steps_chrono  <- ggplot (complete_n_voyages, aes(x=yearam, y=n))  
ggplot_steps_chrono  +
       geom_step () +
       scale_x_continuous(breaks=seq(1500, 1875, by=10)) +
      # habillage
      ylab("expéditions") +                       
      xlab("années") +
      theme_bw() +
      ggtitle ("Distribution chronologique des expéditions de traite atlantique") +
            annotate("text", x = 1880, y = 120, label="The Trans-Atlantic Slave Trade Database (2010) variable yearam", size = 4, angle = 90) 
```

### ### Représentations graphiques en bâtons

```{r eval=FALSE}

# Proposition 1

ggplot_barplot_chrono1 <- ggplot (complete_n_voyages, aes(x=yearam, y=n))  
ggplot_barplot_chrono1 +
       geom_bar (stat="identity", colour="grey40") +
       scale_x_continuous(breaks=seq(1500, 1875, by=10)) +
      # habillage
      ylab("expéditions") +                       
      xlab("années") +
      theme_bw() +
      ggtitle ("Distribution chronologique des expéditions de traite atlantique") +
            annotate("text", x = 1880, y = 120, label="The Trans-Atlantic Slave Trade Database (2010) variable yearam", size = 4, angle = 90) 

````


```{r}

# Proposition 2
##  remplissage des bâtons/ dégradé proportionnel aux effectifs
##  + assignation d'une bordure  aux bâtons.
##  + Barres plus larges 

ggplot_barplot_chrono2 <- ggplot (n_voyages, aes(x=yearam, y=n, , width=2))  
ggplot_barplot_chrono2 +
  geom_bar(stat="identity", aes(fill = n), colour="grey40") +
  scale_fill_continuous() +
  scale_x_continuous(breaks=seq(1500, 1860, by=25)) +
# habillage
      ylab("expéditions") +                       
      xlab("années") +
      theme_bw() +
      theme(legend.title=element_blank()) +
      ggtitle ("Distribution chronologique des expéditions de traite atlantique") +
            annotate("text", x = 1880, y = 120, label="The Trans-Atlantic Slave Trade Database (2010) variable yearam", size = 4, angle = 90)

````


réfécences

http://yohann.feneche.free.fr/lissage_mm.php
http://stackoverflow.com/questions/13840761/add-moving-average-plot-to-time-series-plot-in-r
http://www.princeton.edu/~jswaters/site/Notes/Entries/2013/9/9_R__Plotting_time_series_data.html
http://java.dzone.com/articles/r-ggplot---plotting-multiple
https://danieljhocking.wordpress.com/2014/12/03/lags-and-moving-means-in-dplyr/

```

##  Creation d'un data.frame de moyenne mobile



```{r eval=FALSE}
library (dplyr)
library (zoo)

nvymobile <- 
  voyages %>%
  group_by(yearam)  %>% 
  summarise(y = n()) %>%
  mutate (moyennemobile=rollmean(x=y,5, align="right", fill=0 )) 
utils :: View (nvymobile)

````

fill: moyenne d'anterieure donc par quoi remplacer les valerus non prises ne compte NA 0?


http://stackoverflow.com/questions/23619855/constructing-moving-average-over-a-categorical-variable-in-r
http://www.inside-r.org/packages/cran/zoo/docs/rollapply




### {GoogleVis}


```{r  eval = FALSE}
library (googleVis)

complete_n_voyages_rename <- complete_n_voyages %>%
                      rename(voyages = n)

gvis_chrono1 <- gvisLineChart(complete_n_voyages_rename, 
                            options=list(
                              legend="none",
                              lineWidth=2, pointSize=0,
                              title="Trans-Atlantic slave trade voyages (yearam variable)",
                              vAxis="{title:''}",
                              width=1500, height=600))
plot (gvis_chrono1)


gvis_chrono2 <- gvisColumnChart(complete_n_voyages2-rename,
options=list(
                              legend="none",
                              lineWidth=2, pointSize=0,
                              title="Trans-Atlantic slave trade voyages (yearam variable)",
                              vAxis="{title:''}",
                              width=1500, height=600))
plot(gvis_chrono2)
```

# Périodisation de la traite

Lorsque presque tous les individus possèdent des valeurs différentes, on peut procéder à un regroupement par classes des valeurs observées afin d'en faciliter la lecture, l'analyse et interprétation. Le découpage en classes d'une population selon un ou plusieurs critères est une opération appelée *discrétisation*.

Cette transformation engendre une perte d'information. Par conséquent, le processus de partition en classes (définition des limites de classes, étendue des classes, nombre de classes, etc.), qui comporte nécessairement une part d'arbitraire, revêt une grande importance. (Sède-Marceau, 2010; Saly-Giocanty, 2005, p.31)
Une classe est un intervalle de valeurs ue peut prendre le le caractère quantitatif étudié.
L'amplitude d'une classe est la longueur de l'intervalle de valeurs. Les classes peuvent être d'amplitudes différentes. (math en poche 2nde)

```{r  eval=FALSE}


cut_chrono1 <- cut(voyages$yearam,
          breaks=c(1500 ,1600 ,1800 ,1900))

table (cut_chrono1)

# Suppression de la notation scientifique (utilisation de l'argument dig.lab)

cut_chrono2 <- cut(voyages$yearam,
          breaks=c(1500 ,1600 ,1800 ,1900),
          dig.lab = 4,
          
          right = FALSE)
cut_chrono2

# bornes exlues à droite
table (cut_chrono1)


```


```{r  eval = FALSE}
library (dplyr)

cut_chrono3 <- voyages %>%
               select (yearam, voyageid, shipname) %>%
               mutate (periodes = cut(yearam, breaks = c(1500, 1789, 1807, 1866),
               include.lowest = TRUE, # bornes semi-ouvertes exclues à droite
               right = FALSE,  
               dig.lab = 4))




cut_chrono3 <- voyages %>%
               select (yearam, voyageid, shipname) %>%
mutate (periodes = cut(yearam, breaks = c(1500, 1789, 1807, 1866),
                                                include.lowest = TRUE,
                        right = FALSE,  
                        dig.lab = 4)) %>%
                        count (periodes)

# bornes semi-ouvertes exclues à droite
cut_chrono3
```




